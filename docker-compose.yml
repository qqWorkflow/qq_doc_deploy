version: "3.8"

services:
  git-sync:
    image: registry.k8s.io/git-sync/git-sync:v4.4.0
    environment:
      GITSYNC_REPO: "${GIT_REPO}"
      GITSYNC_BRANCH: "main"
      GITSYNC_ROOT: "/git"
      GITSYNC_LINK: "current"
      GITSYNC_PERIOD: "60s"
      GITSYNC_SSH: "true"
      GITSYNC_SSH_KEY_FILE: "/etc/git-secret/ssh"
      GITSYNC_SSH_KNOWN_HOSTS_FILE: "/etc/git-secret/known_hosts"
    volumes:
      - repo-data:/git
      - ${SSH_KEY_PATH}:/etc/git-secret/ssh:ro
      - ./known_hosts:/etc/git-secret/known_hosts:ro
    restart: unless-stopped

  docs:
    build: .
    volumes:
      - repo-data:/git:ro
      - static-data:/static
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/docs-ready"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 120s

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - static-data:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      docs:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/en/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  repo-data:
  static-data:
